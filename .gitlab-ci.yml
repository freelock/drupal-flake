################
# GitLabCI template for Drupal projects.
#
# This template is designed to give any Contrib maintainer everything they need to test, without requiring modification.
# It is also designed to keep up to date with Core Development automatically through the use of include files that can be centrally maintained.
# As long as you include the project, ref and three files below, any future updates added by the Drupal Association will be used in your
# pipelines automatically. However, you can modify this template if you have additional needs for your project.
# The full documentation is on https://project.pages.drupalcode.org/gitlab_templates/
################

# For information on alternative values for 'ref' see https://project.pages.drupalcode.org/gitlab_templates/info/templates-version/
# To test a Drupal 7 project, change the first include filename from .main.yml to .main-d7.yml
include:
  - project: $_GITLAB_TEMPLATES_REPO
    ref: $_GITLAB_TEMPLATES_REF
    file:
      - '/includes/include.drupalci.variables.yml'
      - '/includes/include.drupalci.workflows.yml'

################
# Pipeline configuration variables are defined with default values and descriptions in the file
# https://git.drupalcode.org/project/gitlab_templates/-/blob/main/includes/include.drupalci.variables.yml
# Override variables for this Nix flake project
################
variables:
  # Skip all PHP-based tests since this is a Nix project
  SKIP_PHPUNIT: '1'
  SKIP_PHPCS: '1'
  SKIP_ESLINT: '1'
  SKIP_STYLELINT: '1'
  SKIP_PHPSTAN: '1'
  SKIP_UPGRADE_STATUS: '1'
  # Set target core to none since this isn't a Drupal module
  _TARGET_CORE: 'none'
  # Use NixOS image with Nix pre-installed
  NIXOS_IMAGE: "nixos/nix:latest"

# Custom jobs for Nix flake testing
validate-flake:
  stage: build
  image: $NIXOS_IMAGE
  before_script:
    - echo "Setting up Nix environment..."
    - nix --version
    - mkdir -p ~/.config/nix
    - echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
    - echo "substituters = https://cache.nixos.org https://nix-community.cachix.org" >> ~/.config/nix/nix.conf
    - echo "trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Ky7bkq5CX+/rkCWyvRCYg3Fs=" >> ~/.config/nix/nix.conf
  script:
    - echo "ðŸ” Validating flake configuration..."
    - nix flake check --no-build
    - nix flake show
    - echo "âœ… Flake validation passed"
  rules:
    - changes:
        - "*.nix"
        - "template/**/*.nix"
        - "flake.lock"
        - "template/flake.lock"

test-demo-functionality:
  stage: test
  image: $NIXOS_IMAGE
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "Setting up Nix environment..."
    - nix --version
    - mkdir -p ~/.config/nix
    - echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
    - echo "substituters = https://cache.nixos.org https://nix-community.cachix.org" >> ~/.config/nix/nix.conf
    - echo "trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Ky7bkq5CX+/rkCWyvRCYg3Fs=" >> ~/.config/nix/nix.conf
  script:
    - echo "ðŸ§ª Running demo functionality tests..."
    - nix profile install nixpkgs#process-compose nixpkgs#procps
    - chmod +x tests/test-demo.sh
    - ./tests/test-demo.sh
  artifacts:
    when: always
    paths:
      - test-logs/
    expire_in: 1 week
  timeout: 30m

test-xdebug-functionality:
  stage: test
  image: $NIXOS_IMAGE
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "Setting up Nix environment..."
    - nix --version
    - mkdir -p ~/.config/nix
    - echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
    - echo "substituters = https://cache.nixos.org https://nix-community.cachix.org" >> ~/.config/nix/nix.conf
    - echo "trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Ky7bkq5CX+/rkCWyvRCYg3Fs=" >> ~/.config/nix/nix.conf
  script:
    - echo "ðŸ§ª Running XDebug functionality tests..."
    - nix profile install nixpkgs#process-compose nixpkgs#procps
    - chmod +x tests/test-xdebug.sh
    - ./tests/test-xdebug.sh
  artifacts:
    when: always
    paths:
      - test-logs/
    expire_in: 1 week
  timeout: 20m

test-detached-parsing:
  stage: test
  image: $NIXOS_IMAGE
  before_script:
    - echo "Setting up Nix environment..."
    - nix --version
    - mkdir -p ~/.config/nix
    - echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
  script:
    - echo "ðŸ§ª Running detached parsing tests..."
    - chmod +x tests/test-detached-parsing.sh
    - ./tests/test-detached-parsing.sh
  artifacts:
    when: always
    paths:
      - test-logs/
    expire_in: 1 week
  timeout: 10m